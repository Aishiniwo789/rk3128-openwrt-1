name: Build RK3128 OpenWrt Print Server
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build_openwrt:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
      - name: Step 1 - Checkout repository
        uses: actions/checkout@v4

      - name: Step 2 - Clean space and install dependencies
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt update -y && sudo apt full-upgrade -y
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev python3 python3-pip python3-setuptools python3-wheel rsync subversion unzip zlib1g-dev file wget curl xz-utils dosfstools squashfs-tools

      - name: Step 3 - Clone OpenWrt 23.05 source code
        run: git clone -b openwrt-23.05 --depth 1 https://github.com/openwrt/openwrt.git openwrt

      - name: Step 4 - Copy RK3128 DTS to correct path
        run: |
          mkdir -p openwrt/target/linux/rockchip/dts/armv7
          cp rk3128-tvbox-rk3128.dts openwrt/target/linux/rockchip/dts/armv7/

      - name: Step 5 - Copy kernel patches
        run: |
          mkdir -p openwrt/target/linux/rockchip/patches-5.15
          cp 0001-rk3128-add-tvbox-support.patch openwrt/target/linux/rockchip/patches-5.15/
          cp 0002-rk3128-fix-wifi-usb-power.patch openwrt/target/linux/rockchip/patches-5.15/

      - name: Step 6 - Copy config file
        run: cp .config openwrt/

      - name: Step 7 - Update and install feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Step 8 - Build firmware
        run: |
          cd openwrt
          make defconfig
          make -j$(nproc) download V=s
          make -j$(nproc) || make -j1 V=s

      - name: Step 9 - Check build files
        run: |
          cd openwrt
          ls -l bin/targets/rockchip/armv7/
          ls -l bin/targets/rockchip/armv7/generic/

      - name: Step 10 - Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: RK3128-OpenWrt-Printer-Server
          path:
            openwrt/bin/targets/rockchip/armv7/**/*
            openwrt/bin/targets/rockchip/armv7/*.img
            openwrt/bin/targets/rockchip/armv7/*.img.gz
            openwrt/bin/targets/rockchip/armv7/*.factory.img
            openwrt/bin/targets/rockchip/armv7/*.sysupgrade.bin
          if-no-files-found: error
