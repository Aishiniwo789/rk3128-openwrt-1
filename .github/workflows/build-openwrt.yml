# OpenWrt 23.05 for RK3128 TVBOX (HDMI+2USB+LAN+AV) 打印服务器专用
name: Build RK3128 OpenWrt 打印服务器固件
on:
  push:
    branches: [ main ]
  workflow_dispatch: # 手动触发编译按钮，核心，方便随时编译

jobs:
  build_openwrt:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
      - name: 1. 检出仓库文件
        uses: actions/checkout@v4

      - name: 2. 安装编译依赖环境（一键安装，无遗漏）
        run: |
          sudo apt update -y
          sudo apt full-upgrade -y
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses-dev libssl-dev python3 python3-pip python3-setuptools python3-wheel \
          rsync subversion unzip zlib1g-dev file wget curl

      - name: 3. 拉取稳定版OpenWrt源码（23.05，RK3128最佳适配）
        run: git clone -b openwrt-23.05 --depth 1 https://github.com/openwrt/openwrt.git openwrt

      - name: 4. 复制精准适配的设备树到源码目录
        run: |
          mkdir -p openwrt/target/linux/rockchip/dts/rk3128
          cp rk3128-tvbox-rk3128.dts openwrt/target/linux/rockchip/dts/rk3128/

      - name: 5. 复制编译配置文件
        run: cp .config openwrt/

      - name: 6. 更新软件源+安装依赖包
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: 7. 生成最终配置+开始编译固件
        run: |
          cd openwrt
          make defconfig
          make -j$(nproc) download V=s
          make -j$(nproc) V=s || make -j1 V=s

      - name: 8. 编译完成-上传固件（可直接下载）
        uses: actions/upload-artifact@v4
        with:
          name: RK3128-OpenWrt-打印服务器固件
          path: |
            openwrt/bin/targets/rockchip/rk3128/*.img.gz
            openwrt/bin/targets/rockchip/rk3128/*.img
