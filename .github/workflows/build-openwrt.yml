name: Build RK3128 OpenWrt Print Server
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build_openwrt:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
      - name: Step 1 - Checkout repository
        uses: actions/checkout@v4

      - name: Step 2 - Clean space and install full dependencies
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt update -y && sudo apt full-upgrade -y
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev python3 python3-pip python3-setuptools python3-wheel rsync subversion unzip zlib1g-dev file wget curl xz-utils dosfstools squashfs-tools

      - name: Step 3 - Clone OpenWrt 23.05 stable source
        run: git clone -b openwrt-23.05 --depth 1 https://github.com/openwrt/openwrt.git openwrt

      - name: Step 4 - Copy RK3128 DTS to correct path (WIFI+USB+LAN+HDMI+AV)
        run: |
          mkdir -p openwrt/target/linux/rockchip/dts/armv7
          cp rk3128-tvbox-rk3128.dts openwrt/target/linux/rockchip/dts/armv7/

      - name: Step 5 - Auto add RK3128 device support (替代补丁，核心修复)
        run: |
          echo -e "define Device/rockchip-rk3128-tvbox\n  DEVICE_VENDOR := Generic\n  DEVICE_MODEL := RK3128 TV Box\n  DEVICE_DTS := rk3128-tvbox-rk3128\n  DEVICE_PACKAGES := kmod-usb-printer kmod-brcmfmac kmod-brcmutil wpad-mbedtls\nendef\nTARGET_DEVICES += rockchip-rk3128-tvbox" >> openwrt/target/linux/rockchip/image/armv7.mk

      - name: Step 6 - Copy config file (内置打印服务+中文+全驱动)
        run: cp .config openwrt/

      - name: Step 7 - Update feeds and install all packages
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Step 8 - Build firmware (防失败，单核兜底)
        run: |
          cd openwrt
          make defconfig
          make -j$(nproc) download V=s
          make -j$(nproc) || make -j1 V=s

      - name: Step 9 - Check firmware files
        run: |
          cd openwrt
          ls -l bin/targets/rockchip/armv7/
          ls -l bin/targets/rockchip/armv7/generic/

      - name: Step 10 - Upload firmware (100%能找到文件)
        uses: actions/upload-artifact@v4
        with:
          name: RK3128-OpenWrt-Printer-Server-Final
          path:
            openwrt/bin/targets/rockchip/armv7/**/*.img
            openwrt/bin/targets/rockchip/armv7/**/*.img.gz
            openwrt/bin/targets/rockchip/armv7/**/*.sysupgrade.bin
            openwrt/bin/targets/rockchip/armv7/**/*.factory.img
          if-no-files-found: error
