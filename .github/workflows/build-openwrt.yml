name: Build RK3128 OpenWrt Print Server
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
运行: |
          sudo apt update -y
          sudo apt remove -y docker.io docker-compose
          sudo apt full-upgrade -y
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev python3 rsync unzip zlib1g-dev file wget curl xz-utils squashfs-tools

      - name: Clone OpenWrt Source
        run: git clone -b openwrt-23.05 --depth=1 https://github.com/openwrt/openwrt.git openwrt

      - name: Copy DTS to Correct Path
运行: |
          mkdir -p openwrt/target/linux/rockchip/dts/legacy
          cp rk3128-box.dts openwrt/target/linux/rockchip/dts/legacy/

      - name: 复制配置文件
        run: cp .config openwrt/

      - name: 更新源
运行: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - 名称: 构建固件
运行: |
          cd openwrt
          make defconfig
          make download -j$(nproc)
          make -j$(nproc) || make -j1 V=s

      - name: 上传固件
        uses: actions/upload-artifact@v4
与:
          name: RK3128-OpenWrt-Printer-Firmware
路径:
            openwrt/bin/targets/rockchip/legacy/*
            openwrt/bin/targets/rockchip/legacy/*.img
            openwrt/bin/targets/rockchip/legacy/*.img.gz
            openwrt/bin/targets/rockchip/legacy/*.sysupgrade.bin
          if-no-files-found: error
