name: Build RK3128 OpenWrt Print Server
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Dependencies
        run: sudo apt update -y && sudo apt full-upgrade -y && sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev python3 rsync unzip zlib1g-dev file wget curl xz-utils squashfs-tools ncurses-term
      - name: Clone OpenWrt 22.03 (RK3128最佳稳定版)
        run: git clone -b openwrt-22.03 --depth=1 https://github.com/openwrt/openwrt.git openwrt
      - name: Copy RK3128 DTS File
        run: mkdir -p openwrt/target/linux/rockchip/dts/legacy && cp rk3128-box.dts openwrt/target/linux/rockchip/dts/legacy/
      - name: Copy RK3128 Config & Force Lock 32bit (核心修复)
        run: cp .config openwrt/ && echo -e "CONFIG_TARGET_rockchip_armv8=n\nCONFIG_TARGET_rockchip_legacy=y\nCONFIG_TARGET_rockchip_legacy_DEVICE_generic=y" >> openwrt/.config
      - name: Clean All Cache (彻底清除残留，关键步骤)
        run: cd openwrt && rm -rf tmp/ .config.old build_dir/ staging_dir/ && make clean
      - name: Update Feeds & Install All
        run: cd openwrt && ./scripts/feeds update -a && ./scripts/feeds install -a
      - name: Build Firmware (无报错编译，强制单核兜底)
        run: cd openwrt && export TERM=xterm && make defconfig && make download -j$(nproc) && make -j1 V=s
      - name: Show Only RK3128 Firmware (核对机型，无错误固件)
        run: find openwrt/bin -name "*.img*" | grep rockchip | grep legacy
      - name: Upload RK3128 Exclusive Firmware
        uses: actions/upload-artifact@v4
        with:
          name: RK3128-OpenWrt-Printer-Firmware
          path:
            openwrt/bin/targets/rockchip/legacy/*.img
            openwrt/bin/targets/rockchip/legacy/*.img.gz
          if-no-files-found: error
